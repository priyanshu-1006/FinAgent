<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinAgent - AI Financial Assistant Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --success: #00C853;
            --warning: #FFB300;
            --danger: #FF3D00;
            --bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --text: #1A1A2E;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 32px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #00C6FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-badge.running {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .status-badge.stopped {
            background: rgba(255, 61, 0, 0.1);
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-badge.running .status-dot {
            background: var(--success);
        }

        .status-badge.stopped .status-dot {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* Command Input Panel */
        .command-panel {
            display: flex;
            flex-direction: column;
        }

        .command-input-container {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .command-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .command-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .send-btn {
            padding: 14px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Quick Commands */
        .quick-commands {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .quick-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-btn {
            padding: 8px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Activity Feed */
        .activity-feed {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .activity-item {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .activity-icon.command { background: rgba(0, 102, 255, 0.1); }
        .activity-icon.success { background: rgba(0, 200, 83, 0.1); }
        .activity-icon.error { background: rgba(255, 61, 0, 0.1); }
        .activity-icon.approval { background: rgba(255, 179, 0, 0.1); }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Browser Preview */
        .browser-preview {
            background: #1a1a2e;
            border-radius: 16px;
            overflow: hidden;
        }

        .browser-header {
            background: #2d2d44;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .browser-dots {
            display: flex;
            gap: 6px;
        }

        .browser-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .browser-dot.red { background: #ff5f56; }
        .browser-dot.yellow { background: #ffbd2e; }
        .browser-dot.green { background: #27c93f; }

        .browser-url {
            flex: 1;
            background: rgba(255,255,255,0.1);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            color: #aaa;
        }

        .browser-body {
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .browser-body img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Approval Panel */
        .approval-panel {
            display: flex;
            flex-direction: column;
        }

        .approval-card {
            margin: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-radius: 12px;
            border-left: 4px solid var(--warning);
        }

        .approval-title {
            font-size: 16px;
            font-weight: 600;
            color: #E65100;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .approval-details {
            font-size: 14px;
            color: #5D4037;
            margin-bottom: 16px;
        }

        .approval-params {
            background: rgba(255,255,255,0.5);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .approval-actions {
            display: flex;
            gap: 12px;
        }

        .approve-btn, .reject-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .approve-btn {
            background: var(--success);
            color: white;
        }

        .approve-btn:hover {
            background: #00A843;
        }

        .reject-btn {
            background: var(--danger);
            color: white;
        }

        .reject-btn:hover {
            background: #E63600;
        }

        /* Task Progress */
        .task-progress {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .task-id {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .task-status.completed { background: rgba(0,200,83,0.1); color: var(--success); }
        .task-status.in_progress { background: rgba(0,102,255,0.1); color: var(--primary); }
        .task-status.failed { background: rgba(255,61,0,0.1); color: var(--danger); }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .step-list {
            margin-top: 12px;
        }

        .step-item {
            font-size: 13px;
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-icon {
            width: 20px;
            text-align: center;
        }

        .step-item.completed .step-icon { color: var(--success); }
        .step-item.in-progress .step-icon { color: var(--primary); }
        .step-item.pending .step-icon { color: var(--text-secondary); }

        /* Empty State */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            .browser-preview {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ü§ñ</span>
                <span class="logo-text">FinAgent</span>
                <span style="color: var(--text-secondary); font-size: 14px;">AI Financial Assistant</span>
            </div>
            <div class="header-right">
                <div id="status-badge" class="status-badge stopped">
                    <span class="status-dot"></span>
                    <span id="status-text">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Command Panel -->
        <div class="card command-panel">
            <div class="card-header">
                <h3 class="card-title">üí¨ Command Center</h3>
            </div>
            
            <div class="command-input-container">
                <input 
                    type="text" 
                    id="command-input" 
                    class="command-input" 
                    placeholder="Type a command... e.g., 'Pay electricity bill of ‚Çπ1500'"
                    autocomplete="off"
                >
                <button id="send-btn" class="send-btn">Execute</button>
            </div>

            <div class="quick-commands">
                <p class="quick-label">Quick Commands</p>
                <div class="quick-btns">
                    <button class="quick-btn" data-cmd="login to my account">üîê Login</button>
                    <button class="quick-btn" data-cmd="check my balance">üí∞ Balance</button>
                    <button class="quick-btn" data-cmd="pay electricity bill of 1250 rupees">üí° Pay Bill</button>
                    <button class="quick-btn" data-cmd="transfer 2000 to Mom">üí∏ Transfer</button>
                    <button class="quick-btn" data-cmd="buy gold worth 1000">ü•á Buy Gold</button>
                </div>
            </div>

            <div class="activity-feed" id="activity-feed">
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <p>Activity will appear here</p>
                </div>
            </div>
        </div>

        <!-- Browser Preview -->
        <div class="card browser-preview">
            <div class="browser-header">
                <div class="browser-dots">
                    <span class="browser-dot red"></span>
                    <span class="browser-dot yellow"></span>
                    <span class="browser-dot green"></span>
                </div>
                <div class="browser-url" id="browser-url">localhost:8080</div>
            </div>
            <div class="browser-body" id="browser-body">
                <div class="empty-state">
                    <div class="empty-icon">üåê</div>
                    <p>Browser preview will appear here</p>
                    <p style="margin-top: 8px; font-size: 12px;">Execute a command to start</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Approvals & Tasks -->
        <div class="card approval-panel">
            <div class="card-header">
                <h3 class="card-title">‚ö†Ô∏è Pending Approvals</h3>
            </div>
            
            <div id="approvals-container">
                <div class="empty-state">
                    <div class="empty-icon">‚úÖ</div>
                    <p>No pending approvals</p>
                </div>
            </div>

            <div class="card-header" style="margin-top: auto;">
                <h3 class="card-title">üìã Current Task</h3>
            </div>
            
            <div id="task-container">
                <div class="empty-state">
                    <div class="empty-icon">üéØ</div>
                    <p>No active task</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== State =====
        let ws = null;
        let isConnected = false;
        let activities = [];
        let currentTask = null;
        let pendingApprovals = [];

        // ===== DOM Elements =====
        const commandInput = document.getElementById('command-input');
        const sendBtn = document.getElementById('send-btn');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        const activityFeed = document.getElementById('activity-feed');
        const browserBody = document.getElementById('browser-body');
        const browserUrl = document.getElementById('browser-url');
        const approvalsContainer = document.getElementById('approvals-container');
        const taskContainer = document.getElementById('task-container');

        // ===== WebSocket Connection =====
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                isConnected = true;
                updateStatus(true);
                addActivity('üü¢', 'Connected to FinAgent', 'success');
            };
            
            ws.onclose = () => {
                isConnected = false;
                updateStatus(false);
                addActivity('üî¥', 'Disconnected from FinAgent', 'error');
                
                // Reconnect after 3 seconds
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
        }

        function handleMessage(message) {
            switch(message.type) {
                case 'initial_status':
                    updateStatus(message.data.is_running);
                    if (message.data.pending_approvals.length > 0) {
                        pendingApprovals = message.data.pending_approvals;
                        renderApprovals();
                    }
                    break;
                
                case 'status':
                    addActivity('‚ÑπÔ∏è', message.message, 'command');
                    break;
                
                case 'screenshot':
                    updateScreenshot(message.data);
                    break;
                
                case 'approval_request':
                    pendingApprovals.push(message.data);
                    renderApprovals();
                    addActivity('‚ö†Ô∏è', `Approval needed: ${message.data.description}`, 'approval');
                    break;
                
                case 'task_update':
                    currentTask = message.data;
                    renderTask();
                    break;
            }
        }

        // ===== UI Updates =====
        function updateStatus(running) {
            statusBadge.className = `status-badge ${running ? 'running' : 'stopped'}`;
            statusText.textContent = running ? 'Connected' : 'Disconnected';
        }

        function addActivity(icon, text, type) {
            activities.unshift({
                icon,
                text,
                type,
                time: new Date().toLocaleTimeString()
            });
            
            // Keep only last 20
            activities = activities.slice(0, 20);
            renderActivities();
        }

        function renderActivities() {
            if (activities.length === 0) {
                activityFeed.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>Activity will appear here</p>
                    </div>
                `;
                return;
            }
            
            activityFeed.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.type}">${a.icon}</div>
                    <div class="activity-content">
                        <p class="activity-title">${a.text}</p>
                        <p class="activity-time">${a.time}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateScreenshot(base64) {
            browserBody.innerHTML = `<img src="data:image/png;base64,${base64}" alt="Browser Screenshot">`;
        }

        function renderApprovals() {
            if (pendingApprovals.length === 0) {
                approvalsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <p>No pending approvals</p>
                    </div>
                `;
                return;
            }
            
            approvalsContainer.innerHTML = pendingApprovals.map(a => `
                <div class="approval-card">
                    <div class="approval-title">‚ö†Ô∏è ${a.action.replace('_', ' ').toUpperCase()}</div>
                    <p class="approval-details">${a.description}</p>
                    <div class="approval-params">
                        ${Object.entries(a.parameters)
                            .filter(([k, v]) => v && k !== 'parent_action')
                            .map(([k, v]) => `<strong>${k}:</strong> ${v}`)
                            .join('<br>')}
                    </div>
                    <div class="approval-actions">
                        <button class="reject-btn" onclick="handleApproval('${a.id}', false)">‚úï Reject</button>
                        <button class="approve-btn" onclick="handleApproval('${a.id}', true)">‚úì Approve</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTask() {
            if (!currentTask) {
                taskContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéØ</div>
                        <p>No active task</p>
                    </div>
                `;
                return;
            }
            
            const progress = (currentTask.current_step / currentTask.total_steps) * 100;
            
            taskContainer.innerHTML = `
                <div class="task-progress">
                    <div class="task-header">
                        <span class="task-id">${currentTask.id}</span>
                        <span class="task-status ${currentTask.status}">${currentTask.status.replace('_', ' ')}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="step-list">
                        ${currentTask.steps.map(s => `
                            <div class="step-item ${s.status}">
                                <span class="step-icon">
                                    ${s.status === 'completed' ? '‚úì' : s.status === 'in_progress' ? '‚óè' : '‚óã'}
                                </span>
                                <span>${s.action.replace(/_/g, ' ')}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ===== Actions =====
        async function executeCommand(command) {
            if (!command.trim()) return;
            
            addActivity('üìù', `Command: ${command}`, 'command');
            commandInput.value = '';
            
            // Send via WebSocket or REST
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'execute', command }));
            } else {
                // Fallback to REST
                try {
                    const response = await fetch('/api/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command })
                    });
                    const result = await response.json();
                    currentTask = result.result;
                    renderTask();
                } catch (error) {
                    addActivity('‚ùå', `Error: ${error.message}`, 'error');
                }
            }
        }

        async function handleApproval(requestId, approved) {
            // Remove from pending
            pendingApprovals = pendingApprovals.filter(a => a.id !== requestId);
            renderApprovals();
            
            addActivity(approved ? '‚úÖ' : '‚ùå', `Action ${approved ? 'approved' : 'rejected'}`, approved ? 'success' : 'error');
            
            // Send via WebSocket or REST
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'approve', request_id: requestId, approved }));
            } else {
                await fetch('/api/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId, approved })
                });
            }
        }

        // ===== Event Listeners =====
        sendBtn.addEventListener('click', () => executeCommand(commandInput.value));
        
        commandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand(commandInput.value);
        });

        document.querySelectorAll('.quick-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cmd = btn.dataset.cmd;
                commandInput.value = cmd;
                executeCommand(cmd);
            });
        });

        // ===== Initialize =====
        connect();
    </script>
</body>
</html>
